name: Check Palisades Parking

on:
  # Run on a schedule (cron is in UTC)
  # Every 10 minutes from 5 AM - midnight PST (1 PM - 8 AM UTC next day)
  # Split into two ranges because cron wraps at midnight UTC.
  schedule:
    - cron: "*/10 13-23 * * *"
    - cron: "*/10 0-8 * * *"

  # Allow manual runs from the GitHub Actions tab
  workflow_dispatch:
    inputs:
      dates:
        description: "Dates to check (space-separated YYYY-MM-DD)"
        required: true
        default: "2026-02-22"
      location:
        description: "Location: palisades, alpine, or both"
        required: true
        default: "palisades"
        type: choice
        options:
          - palisades
          - alpine
          - both

# ============================================================
# CONFIGURATION
# Set your target dates and location here for scheduled runs.
# ============================================================
env:
  # Dates to check (supports: this-weekend, next-weekend, YYYY-MM-DD)
  CHECK_DATES: "this-weekend next-weekend"
  # Only send push notifications if THESE dates open up
  NOTIFY_DATES: "this-weekend"
  # palisades, alpine, or both
  CHECK_LOCATION: "both"

  # --- Notification: ntfy.sh (recommended for iPhone) ---
  # Set NTFY_TOPIC as a repository secret (Settings > Secrets > Actions)
  # NTFY_TOPIC: set in repo secrets

  # --- Notification: Email (optional) ---
  # Set these as repository secrets:
  # SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM, SMTP_TO

  # --- Notification: SMS (optional, uses SMTP + carrier gateway) ---
  # Set these as repository secrets:
  # SMS_PHONE, SMS_CARRIER (att, tmobile, verizon, etc.)

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: palisades

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: Run parking checker
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO: ${{ secrets.SMTP_TO }}
          SMS_PHONE: ${{ secrets.SMS_PHONE }}
          SMS_CARRIER: ${{ secrets.SMS_CARRIER }}
        run: |
          # Use workflow_dispatch inputs if manually triggered, otherwise use env defaults
          DATES="${{ github.event.inputs.dates || env.CHECK_DATES }}"
          LOCATION="${{ github.event.inputs.location || env.CHECK_LOCATION }}"

          # Build notification flags based on which secrets are set
          NOTIFY_FLAGS=""
          if [ -n "$NTFY_TOPIC" ]; then
            NOTIFY_FLAGS="$NOTIFY_FLAGS ntfy"
          fi
          if [ -n "$SMTP_TO" ]; then
            NOTIFY_FLAGS="$NOTIFY_FLAGS email"
          fi
          if [ -n "$SMS_PHONE" ] && [ -n "$SMS_CARRIER" ]; then
            NOTIFY_FLAGS="$NOTIFY_FLAGS sms"
          fi

          ALERT_DATES="${{ env.NOTIFY_DATES }}"

          # Run the checker (single check, no interval â€” GitHub Actions handles scheduling)
          if [ -n "$NOTIFY_FLAGS" ]; then
            python check_parking.py --date $DATES --location "$LOCATION" --notify $NOTIFY_FLAGS --notify-dates $ALERT_DATES
          else
            echo "WARNING: No notification secrets configured. Running check-only (no alerts)."
            echo "Add NTFY_TOPIC, SMTP_*, or SMS_* secrets in repo Settings > Secrets > Actions"
            python check_parking.py --date $DATES --location "$LOCATION"
          fi
